exit 1 # Make sure we do not accidentally run this



                             # Prepare environment

export clustername=try-cloud-certification-instructions
export remote_user=pierre_laporte



                                # Create cluster

# Rightscale and PLA specific
echo $clustername > clustername
ctool launch $clustername 10 &
ctool-pssh-hosts-file $clustername > hosts
ctool-ssh-config $clustername > ssh-config
ssh-merge-config ssh-config



                              # Create hosts files

# Create a "hosts.dse" file that contains DSE machines
# Create a "hosts.stress" file that contains Stress machines
# Create a "hosts.opscenter" file that contains OpsCenter machines



                                # Upload scripts

pscp -h hosts --recursive scripts/ "/home/$remote_user/"



                                  # Checkpoint 
                     # clustername, hosts and ssh-config OK



                            # Create common SSH key

ssh-keygen -t rsa -qf key.$clustername -N ''
pssh -h hosts "mkdir -p .ssh/"
pscp -h hosts key.$clustername "/home/$remote_user/.ssh/id_rsa"
pscp -h hosts key.$clustername.pub "/home/$remote_user/.ssh/id_rsa.pub"
pssh -h hosts 'sudo chmod go-wrx .ssh/id_rsa*'
pssh -h hosts "cat .ssh/id_rsa.pub >> .ssh/authorized_keys"
# Make sure certificates are accepted between nodes, either by disabling StrictHostKeyChecking for local addresses or by running this command on all nodes
# Rightscale specific
for n in `seq 0 9`; do   ssh -oStrictHostKeyChecking=no node$n uptime; done



                               # On ALL machines
                                 # Install Java

pssh -h hosts 'bash scripts/2-install-java'



                    # Install opscenter on one machine (#9)

pssh -h hosts.opscenter 'bash scripts/3-install-opscenter'



                               # On DSE machines
                   # Mount a 1TB data partition on /mnt/data
              # Mount a 80GB commitlog partition on /mnt/commitlog

# Rightscale+gce+ctool specific
sudo mkfs.ext3 /dev/sda2
sudo mount /dev/sda2 /mnt
sudo mkdir /mnt/{data,commitlog}
sudo chmod 777 /mnt/{data,commitlog}

# Check that partitions are correctly setup
pssh --inline-stdout -h hosts.dse 'lsblk'


                               # On DSE machines
                         # Install DSE using OpsCenter

# Download DSE installation package from Datastax website and run the installer in CLI
# Add the seeds in Opscenter and connect to the cluster



                               # On DSE machines
                              # Fix system limits

pssh -h hosts.dse 'bash scripts/4-fix-limits'



                               # On all machines
                          # Make sure swap is disabled

pssh -h hosts 'free -m | tail -1 | grep "Swap:            0          0          0"'



                              # On stress machines
                                # Install Stress
 
# Check https://github.com/DSPN/eval-kit/
# Warning :
# - Coupling on OSX (brew commands)
# - Use of Russel's repository and specific commit "CASSANDRA-7821-TRUNK" to build Stress

